<script>
  MtzLangTrans = {
    _requests: [],

    _notify() {
      // If the Ajax call hasn't returned the translations yet, bail out.
      if (!this._translations) return;

      for (const request of this._requests) {
        const keys = request.keys;
        const map = request.keys.reduce(
          (map, key) => {
            map[key] = this._translations[key] || key;
            return map;
          },
          {});
        request.cb(map);
      }
    },

    _setup() {
      // Create an iron-ajax element to send GET request.
      this.ajax = document.createElement('iron-ajax');
      //this.ajax.setAttribute('method', 'GET');
      this.ajax.addEventListener('response', event => {
        this._translations = event.detail.xhr.response;
        this._notify();
      });
    },

    /**
     * Registers a request for translation of a set of keys.
     * The supplied callback function will be passed a translation map
     * initially, and again every time the language is changed.
     */
    getTranslations(keys, cb) {
      this._requests.push({keys, cb});
      this._notify();
    },

    /**
     * Call this to set the initial language,
     * and again to change it.
     */
    setLanguage(lang) {
      sessionStorage.preferredLanguage = lang;

      if (!this.ajax) this._setup();

      // Send Ajax request to get translations for lang.
      const url = `http://localhost:8080/components/todo/translations/${lang}.json`;
      this.ajax.setAttribute('url', url);
      this.ajax.generateRequest();
    }
  };
</script>
